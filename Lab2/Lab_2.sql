--Tao CSDL
CREATE DATABASE QLDT
USE QLDT 

--Tao bang va khoa
CREATE TABLE SINHVIEN (
	MSSV CHAR(8),
	TENSV NVARCHAR(30) NOT NULL,
	SODT VARCHAR(10),
	LOP CHAR(10) NOT NULL,
	DIACHI NCHAR(50) NOT NULL,
	CONSTRAINT PK_SV PRIMARY KEY(MSSV)
)

CREATE TABLE DETAI (
	MSDT CHAR(6),
	TENDT NVARCHAR(30) NOT NULL,
	CONSTRAINT PK_DT PRIMARY KEY(MSDT)
)

CREATE TABLE SV_DETAI (
	MSSV CHAR(8),
	MSDT CHAR(6),
	CONSTRAINT PK_SV_DT PRIMARY KEY(MSSV, MSDT),
	CONSTRAINT FK01_SV_DT FOREIGN KEY(MSSV) REFERENCES SINHVIEN(MSSV),
	CONSTRAINT FK02_SV_DT FOREIGN KEY(MSDT) REFERENCES DETAI(MSDT)
)

CREATE TABLE HOCHAM (
	MSHH INT,
	TENHH NVARCHAR(20) NOT NULL,
	CONSTRAINT PK_HH PRIMARY KEY(MSHH)
)

CREATE TABLE GIAOVIEN (
	MSGV INT,
	TENGV NVARCHAR(30) NOT NULL,
	DIACHI NVARCHAR(50) NOT NULL,
	SODT VARCHAR(10) NOT NULL,
	MSHH INT,
	NAMHH SMALLDATETIME NOT NULL,
	CONSTRAINT PK_GV PRIMARY KEY(MSGV),
	CONSTRAINT FK_GV FOREIGN KEY(MSHH) REFERENCES HOCHAM(MSHH),
)

CREATE TABLE HOCVI (
	MSHV INT,
	TENHV NVARCHAR(20) NOT NULL,
	CONSTRAINT PK_HV PRIMARY KEY(MSHV)
)

CREATE TABLE CHUYENNGANH (
	MSCN INT,
	TENCN NVARCHAR(30) NOT NULL,
	CONSTRAINT PK_CN PRIMARY KEY(MSCN)
)

CREATE TABLE GV_HV_CN (
	MSGV INT,
	MSHV INT,
	MSCN INT,
	NAM	SMALLDATETIME NOT NULL,
	CONSTRAINT PK_GV_HV_CN PRIMARY KEY(MSGV, MSHV, MSCN),
	CONSTRAINT FK01_GV_HV_CN FOREIGN KEY(MSGV) REFERENCES GIAOVIEN(MSGV),
	CONSTRAINT FK02_GV_HV_CN FOREIGN KEY(MSHV) REFERENCES HOCVI(MSHV),
	CONSTRAINT FK03_GV_HV_CN FOREIGN KEY(MSCN) REFERENCES CHUYENNGANH(MSCN)
)

CREATE TABLE GV_HDDT (
	MSGV INT,
	MSDT CHAR(6),
	DIEM FLOAT NOT NULL,
	CONSTRAINT PK_GV_HDDT PRIMARY KEY(MSGV, MSDT),
	CONSTRAINT FK01_GV_HDDT FOREIGN KEY(MSGV) REFERENCES GIAOVIEN(MSGV),
	CONSTRAINT FK02_GV_HDDT FOREIGN KEY(MSDT) REFERENCES DETAI(MSDT)
)

CREATE TABLE GV_PBDT (
	MSGV INT,
	MSDT CHAR(6),
	DIEM FLOAT NOT NULL,
	CONSTRAINT PK_GV_PBDT PRIMARY KEY(MSGV, MSDT),
	CONSTRAINT FK01_GV_PBDT FOREIGN KEY(MSGV) REFERENCES GIAOVIEN(MSGV),
	CONSTRAINT FK02_GV_PBDT FOREIGN KEY(MSDT) REFERENCES DETAI(MSDT)
)

CREATE TABLE GV_UVDT (
	MSGV INT,
	MSDT CHAR(6),
	DIEM FLOAT NOT NULL,
	CONSTRAINT PK_GV_UVDT PRIMARY KEY(MSGV, MSDT),
	CONSTRAINT FK01_GV_UVDT FOREIGN KEY(MSGV) REFERENCES GIAOVIEN(MSGV),
	CONSTRAINT FK02_GV_UVDT FOREIGN KEY(MSDT) REFERENCES DETAI(MSDT)
)

CREATE TABLE HOIDONG (
	MSHD INT,
	PHONG INT,
	TGBD SMALLDATETIME,
	NGAYHD SMALLDATETIME NOT NULL,
	TINHTRANG NVARCHAR(30) NOT NULL,
	MSGV INT,
	CONSTRAINT PK_HOIDONG PRIMARY KEY(MSHD),
	CONSTRAINT FK_HOIDONG FOREIGN KEY(MSGV) REFERENCES GIAOVIEN(MSGV),
)

CREATE TABLE HOIDONG_GV (
	MSHD INT,
	MSGV INT,
	CONSTRAINT PK_HOIDONG_GV PRIMARY KEY(MSHD, MSGV),
	CONSTRAINT FK01_HOIDONG_GV FOREIGN KEY(MSHD) REFERENCES HOIDONG(MSHD),
	CONSTRAINT FK02_HOIDONG_GV FOREIGN KEY(MSGV) REFERENCES GIAOVIEN(MSGV)
)

CREATE TABLE HOIDONG_DT (
	MSHD INT,
	MSDT CHAR(6),
	QUYETDINH NCHAR(10),
	CONSTRAINT PK_HOIDONG_DT PRIMARY KEY(MSHD, MSDT),
	CONSTRAINT FK01_HOIDONG_DT FOREIGN KEY(MSHD) REFERENCES HOIDONG(MSHD),
	CONSTRAINT FK02_HOIDONG_DT FOREIGN KEY(MSDT) REFERENCES DETAI(MSDT)
)

--Cai dat thoi gian
SET DATEFORMAT DMY

--Nhap du lieu
INSERT INTO SINHVIEN VALUES ('13520001', N'Nguyễn Văn An', '0906762255', 'SE103.U32', N'THỦ ĐỨC')
INSERT INTO SINHVIEN VALUES ('13520002', N'Phan Tấn Đạt', '0975672350', 'IE204.T21', N'QUẬN 1')
INSERT INTO SINHVIEN VALUES ('13520003', N'Nguyễn Anh Hải', '0947578688', 'IE205.R12', N'QUẬN 9')
INSERT INTO SINHVIEN VALUES ('13520004', N'Phạm Tài', '0956757869', 'IE202.A22', N'QUẬN 1')
INSERT INTO SINHVIEN VALUES ('13520005', N'Lê Thúy Hằng', '0976668688', 'SE304.E22', N'THỦ ĐỨC')
INSERT INTO SINHVIEN VALUES ('13520006', N'Ưng Hồng Ân', '0957475898', 'IE208.F33', N'QUẬN 2')

INSERT INTO DETAI VALUES ('97001', N'Quản lý thư viện')
INSERT INTO DETAI VALUES ('97002', N'Nhận dạng vân tay')
INSERT INTO DETAI VALUES ('97003', N'Bán đấu giá trên mạng')
INSERT INTO DETAI VALUES ('97004', N'Quản lý siêu thị')															  
INSERT INTO DETAI VALUES ('97005', N'Xử lý ảnh')																		  
INSERT INTO DETAI VALUES ('97006', N'Hệ giải toán thông minh')															  
																  									   
INSERT INTO SV_DETAI VALUES ('13520001', '97004')
INSERT INTO SV_DETAI VALUES ('13520002', '97005')
INSERT INTO SV_DETAI VALUES ('13520003', '97001')
INSERT INTO SV_DETAI VALUES ('13520004', '97002')
INSERT INTO SV_DETAI VALUES ('13520005', '97003')
INSERT INTO SV_DETAI VALUES ('13520006', '97005')

INSERT INTO HOCHAM VALUES (1, 'PHÓ GIÁO SƯ')
INSERT INTO HOCHAM VALUES (2, 'GIÁO SƯ')

INSERT INTO GIAOVIEN VALUES (00201, N'Trần Trung', N'Bến Tre', '35353535', 1, '1996')
INSERT INTO GIAOVIEN VALUES (00202, N'Nguyễn Văn An', N'Tiền Giang', '67868688', 1, '1996')
INSERT INTO GIAOVIEN VALUES (00203, N'Trần Thu Trang', N'Cần Thơ', '74758687', 1, '1996')
INSERT INTO GIAOVIEN VALUES (00204, N'Nguyễn Thị Loan', N'TP. HCM', '56575868', 2, '2005')
INSERT INTO GIAOVIEN VALUES (00205, N'Chu Tiến', N'Hà Nội', '46466646', 2, '2005')

INSERT INTO HOCVI VALUES (1, N'Kỹ sư')
INSERT INTO HOCVI VALUES (2, N'Cử nhân')
INSERT INTO HOCVI VALUES (3, N'Thạc sĩ')
INSERT INTO HOCVI VALUES (4, N'Tiến sĩ')
INSERT INTO HOCVI VALUES (5, N'Tiến sĩ Khoa học')

INSERT INTO CHUYENNGANH VALUES (1, N'Công nghệ Web')
INSERT INTO CHUYENNGANH VALUES (2, N'Mạng xã hội')
INSERT INTO CHUYENNGANH VALUES (3, N'Quản lý CNTT')
INSERT INTO CHUYENNGANH VALUES (4, N'GIS')

INSERT INTO GV_HV_CN VALUES (00201, 1, 1, '2013')
INSERT INTO GV_HV_CN VALUES (00201, 1, 2, '2013')
INSERT INTO GV_HV_CN VALUES (00201, 2, 1, '2014')
INSERT INTO GV_HV_CN VALUES (00202, 3, 2, '2013')
INSERT INTO GV_HV_CN VALUES (00203, 2, 4, '2014')
INSERT INTO GV_HV_CN VALUES (00203, 3, 4, '2016')
INSERT INTO GV_HV_CN VALUES (00204, 3, 2, '2014')
INSERT INTO GV_HV_CN VALUES (00204, 5, 3, '2015')

INSERT INTO GV_HDDT VALUES(00201, '97001', 8)
INSERT INTO GV_HDDT VALUES(00202, '97002', 7)
INSERT INTO GV_HDDT VALUES(00205, '97001', 9)
INSERT INTO GV_HDDT VALUES(00204, '97004', 7)
INSERT INTO GV_HDDT VALUES(00203, '97005', 9)

INSERT INTO GV_PBDT VALUES (00201, '97005', 8)
INSERT INTO GV_PBDT VALUES (00202, '97001', 7)
INSERT INTO GV_PBDT VALUES (00205, '97004', 9)
INSERT INTO GV_PBDT VALUES (00204, '97003', 7)
INSERT INTO GV_PBDT VALUES (00203, '97002', 9)

INSERT INTO GV_UVDT VALUES (00205, '97005', 8)
INSERT INTO GV_UVDT VALUES (00202, '97005', 7)
INSERT INTO GV_UVDT VALUES (00204, '97005', 9)
INSERT INTO GV_UVDT VALUES (00203, '97001', 7)
INSERT INTO GV_UVDT VALUES (00204, '97001', 9)
INSERT INTO GV_UVDT VALUES (00205, '97001', 8)
INSERT INTO GV_UVDT VALUES (00203, '97003', 7)
INSERT INTO GV_UVDT VALUES (00201, '97003', 9)
INSERT INTO GV_UVDT VALUES (00202, '97003', 7)
INSERT INTO GV_UVDT VALUES (00201, '97004', 9)
INSERT INTO GV_UVDT VALUES (00202, '97004', 8)
INSERT INTO GV_UVDT VALUES (00203, '97004', 7)
INSERT INTO GV_UVDT VALUES (00201, '97002', 9)
INSERT INTO GV_UVDT VALUES (00204, '97002', 7)
INSERT INTO GV_UVDT VALUES (00205, '97002', 9)
INSERT INTO GV_UVDT VALUES (00201, '97006', 9)
INSERT INTO GV_UVDT VALUES (00202, '97006', 7)
INSERT INTO GV_UVDT VALUES (00204, '97006', 9)

INSERT INTO HOIDONG VALUES (1, 002,'7:00', '29/11/2014', N'Thật', 00201)
INSERT INTO HOIDONG VALUES (2, 102,'7:00', '5/12/2014', N'Thật', 00202)
INSERT INTO HOIDONG VALUES (3, 003,'8:00', '6/12/2014', N'Thật', 00203)

INSERT INTO HOIDONG_GV VALUES (1, 00201)
INSERT INTO HOIDONG_GV VALUES (1, 00202)
INSERT INTO HOIDONG_GV VALUES (1, 00203)
INSERT INTO HOIDONG_GV VALUES (1, 00204)
INSERT INTO HOIDONG_GV VALUES (2, 00203)
INSERT INTO HOIDONG_GV VALUES (2, 00202)
INSERT INTO HOIDONG_GV VALUES (2, 00205)
INSERT INTO HOIDONG_GV VALUES (2, 00204)
INSERT INTO HOIDONG_GV VALUES (3, 00201)
INSERT INTO HOIDONG_GV VALUES (3, 00202)
INSERT INTO HOIDONG_GV VALUES (3, 00203)
INSERT INTO HOIDONG_GV VALUES (3, 00204)

INSERT INTO HOIDONG_DT VALUES (1, '97001', N'Được')
INSERT INTO HOIDONG_DT VALUES (1, '97002', N'Được')
INSERT INTO HOIDONG_DT VALUES (2, '97001', N'Không')
INSERT INTO HOIDONG_DT VALUES (2, '97004', N'Không')
INSERT INTO HOIDONG_DT VALUES (1, '97005', N'Được')
INSERT INTO HOIDONG_DT VALUES (3, '97001', N'Không')
INSERT INTO HOIDONG_DT VALUES (3, '97002', N'Được')

-- Hãy thực hiện các truy vấn sau bằng ngôn ngữ SQL:
-- 1. Cho biết danh sách giáo viên gồm mã số GV, Tên GV, Địa chỉ, Số ĐT, tên học hàm của GV.
SELECT GIAOVIEN.MSGV, GIAOVIEN.TENGV, GIAOVIEN.DIACHI, GIAOVIEN.SODT, HOCHAM.TENHH AS TENHOCHAM
FROM GIAOVIEN
INNER JOIN HOCHAM ON GIAOVIEN.MSHH = HOCHAM.MSHH;
--2. Liệt kê danh sách đề tài và tên GVHD tương ứng. 
SELECT DETAI.TENDT AS 'Đề tài', GIAOVIEN.TENGV AS 'GVHD'
FROM DETAI
INNER JOIN GV_HDDT ON DETAI.MSDT = GV_HDDT.MSDT
INNER JOIN GIAOVIEN ON GV_HDDT.MSGV = GIAOVIEN.MSGV;
--3. Cho biết số lượng đề tài đã hướng dẫn ứng với từng GV. 
SELECT GV.MSGV, GV.TENGV, COUNT(HDDT.MSDT) AS 'SoLuongDeTai'
FROM GIAOVIEN GV
LEFT JOIN GV_HDDT HDDT ON GV.MSGV = HDDT.MSGV
GROUP BY GV.MSGV, GV.TENGV
ORDER BY GV.MSGV;
--4. Liệt kê danh sách giảng viên chưa hướng dẫn đề tài nào.
SELECT DISTINCT GV.MSGV, GV.TENGV
FROM GIAOVIEN GV
LEFT JOIN GV_HDDT GH ON GV.MSGV = GH.MSGV
WHERE GH.MSGV IS NULL;
--5. Cho biết GV nào hướng dẫn nhiều đề tài nhất.
WITH SoLuongDeTaiGV AS (
    SELECT GV.MSGV, GV.TENGV, COUNT(DT.MSDT) AS SoLuongDeTai
    FROM GIAOVIEN GV
    JOIN GV_HDDT ON GV.MSGV = GV_HDDT.MSGV
    JOIN DETAI DT ON GV_HDDT.MSDT = DT.MSDT
    GROUP BY GV.MSGV, GV.TENGV
)
SELECT MSGV, TENGV, SoLuongDeTai
FROM SoLuongDeTaiGV
WHERE SoLuongDeTai = (
    SELECT MAX(SoLuongDeTai) FROM SoLuongDeTaiGV
);
--6. Tìm sinh viên với thông tin của bạn MSSV/Họ tên của bạn? Nếu không có hãy thực hiện thao tác thêm vào thông tin của bạn.
SELECT * FROM SINHVIEN WHERE MSSV = '21520094';

SELECT * FROM SINHVIEN WHERE TENSV LIKE N'Lê Trần Anh Quí';

INSERT INTO SINHVIEN (MSSV, TENSV, SODT, LOP, DIACHI) 
VALUES ('21520094', N'Lê Trần Anh Quí', '0797979792', 'HTTT2021', N'Quảng Ngãi');
--7. Xóa sinh viên với thông tin của bạn.
DELETE FROM SINHVIEN WHERE MSSV = '21520094';
DELETE FROM SINHVIEN WHERE TENSV = N'Lê Trần Anh Quí';
--8. Hãy liệt kê danh sách GV, và học vị cao nhất của họ. Thông tin xuất ra gồm: mã số GV, Tên GV, tên Học vị.
SELECT 
    GV.MSGV AS MaSoGV, 
    GV.TENGV AS TenGV, 
    HV.TENHV AS TenHocVi
FROM 
    GIAOVIEN GV
JOIN 
    GV_HV_CN ON GV.MSGV = GV_HV_CN.MSGV
JOIN 
    HOCVI HV ON GV_HV_CN.MSHV = HV.MSHV
WHERE 
    GV_HV_CN.NAM = (
        SELECT MAX(NAM) 
        FROM GV_HV_CN 
        WHERE MSGV = GV.MSGV
    )
--9. Liệt kê danh sách GV như sau: MSGV, <Tên học vị  Tên GV>. 
SELECT 
CONCAT(gv.MSGV, ', ', hv.TENHV, ' ', gv.TENGV) AS ThongTinGV
FROM 
    GIAOVIEN GV
JOIN 
    HOCVI HV ON GV.MSHH = HV.MSHV